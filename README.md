# Notion Webhook Server

ChatGPTからNotionデータベースへの自動投稿を行うWebhookサーバー

## 機能概要

- ChatGPTからのメッセージを受け取り、Notionデータベースに自動で投稿
- ステータス管理（未着手、進行中、完了）
- エラーハンドリングとログ出力
- セキュアな環境変数管理

## セットアップ手順

### 1. Notion APIの設定

1. Notionインテグレーションの作成
   - [Notion Developers](https://www.notion.so/my-integrations) にアクセス
   - 「新しいインテグレーション」をクリック
   - 名前を設定（例：`ChatGPT Webhook Bot`）
   - 必要な機能を選択：
     - コンテンツの読み取り
     - コンテンツの更新
     - コンテンツの挿入
   - インテグレーションシークレット（`NOTION_TOKEN`）をコピーして保存

2. データベースの作成と設定
   - Notionで新規データベースを作成
   - 必要なプロパティを設定：
     - 名前（タイトル型）
     - Status（ステータス型）
       - 未着手
       - 進行中
       - 完了
     - テキスト（リッチテキスト型）
     - URL（URL型）
     - 日付（日付型）

3. **重要**: データベースIDの取得（更新された手順）
   - データベースページを開く
   - 右上の「...」（その他のオプション）をクリック
   - 「ビューのリンクをコピー」を選択
   - URLの形式: `https://www.notion.so/workspace/[データベース名]-[データベースID]`
   - データベースIDは32文字の英数字です（ハイフンを除く）
   - ⚠️ 注意: 
     - ブラウザのURLバーから直接コピーしたIDは使用できません
     - 必ず「ビューのリンクをコピー」から取得してください
     - IDの例: `1ff74c56666e80fea8d8e73c2cde1df8`

4. データベースとインテグレーションの接続（更新された手順）
   - データベースページで右上の「...」をクリック
   - 「接続」を選択（以前の「統合」から変更されました）
   - 作成したインテグレーションを検索して追加
   - ✅ 接続が成功すると、インテグレーションがリストに表示されます

### 2. 環境設定

1. 必要なパッケージのインストール
   ```bash
   pip install -r requirements.txt
   ```

2. 環境変数の設定
   - `.env`ファイルを作成
   ```env
   NOTION_TOKEN=your_integration_secret
   NOTION_DATABASE_ID=your_database_id
   PORT=10000  # オプション：デフォルトは10000
   ```

### 3. サーバーの起動と動作確認

1. ローカル環境での起動
   ```bash
   python main.py
   ```

2. 動作確認
   - サーバー起動時に自動的にNotion接続テストが実行されます
   - 成功時: "✅ Notion接続テスト成功" と表示
   - エラー時: 詳細なエラーメッセージが表示されます

## API仕様

1. Webhookエンドポイント
   - URL: `http://your-server:10000/webhook`
   - メソッド: POST
   - Content-Type: application/json

2. リクエスト形式
   ```json
   {
     "message": "投稿したい内容"
   }
   ```

3. レスポンス形式
   ```json
   {
     "status": "success",
     "notion_status": 200,
     "notion_response": {
       "object": "page",
       "id": "ページID",
       // ... その他のレスポンス情報
     }
   }
   ```

## トラブルシューティング

1. 404エラー（データベースが見つからない）
   - **最も多い原因**: データベースIDの取得方法が間違っている
   - 解決方法:
     1. データベースページを開く
     2. 「ビューのリンクをコピー」から正しいIDを取得
     3. ハイフンを除いた32文字の英数字を使用

2. 認証エラー
   - インテグレーションシークレットの確認
   - データベースとインテグレーションの接続状態の確認
   - 解決方法:
     1. インテグレーションページで正しいトークンを確認
     2. データベースの「接続」メニューでインテグレーションが表示されているか確認

3. その他のエラー
   - ログ出力を確認（開発環境では詳細なログが出力されます）
   - 環境変数が正しく設定されているか確認
   - Notionデータベースのプロパティ名が正しいか確認

## デプロイ情報

本サーバーはRenderを使用してデプロイすることを想定しています。

1. 必要なファイル
   - `.render.yaml`: デプロイ設定
   - `requirements.txt`: 依存パッケージ
   - `main.py`: メインアプリケーション

2. 環境変数の設定（Render上）
   - `NOTION_TOKEN`: NotionのインテグレーションシークレットをSecretとして設定
   - `NOTION_DATABASE_ID`: NotionのデータベースIDをSecretとして設定
   - `FLASK_ENV`: `production`
   - `PORT`: `10000`

## セキュリティ注意事項

1. 環境変数の管理
   - `.env`ファイルをGitにコミットしない
   - 本番環境では必ずSecretとして設定

2. アクセス制御
   - 本番環境ではファイアウォールやアクセス制限を適切に設定
   - 必要に応じて認証機能を追加

## 開発者向け情報

- Python 3.8以上推奨
- Flask + gunicornによるWebサーバー実装
- Notion API Version: 2022-06-28
- ログレベル:
  - 開発環境: 詳細なデバッグログ
  - 本番環境: 重要なログのみ
